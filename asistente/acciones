#!/bin/bash

BASE="/usr/share/asistente-actualizacion/"
PASO_BASH="/usr/share/asistente-actualizacion/paso.conf"

. ${PASO_BASH}

##Determina el Disco Duro al cual instalar y actualizar el burg
parts=$(/sbin/fdisk -l | awk '/^\/dev\// {if ($2 == "*") {if ($6 == "83") { print $1 };}}' |sed s/+//g )
text_orig=/dev/c
disco=${parts:0:8}
result=$(echo $disco | sed -e 's/\//\\\//g')
echo $result

echo 'sed -i "s/\/dev\/xxx/$result/g" $BASE/selections.conf'
sed -i "s/\/dev\/xxx/$result/g" $BASE/selections.conf

while [ ${PASO} -lt 60 ]
do

[ -e /var/lib/dpkg/lock ] || [ $(ps -A | grep -cw apt-get) == 1 ] || [ $(ps -A | grep -cw aptitude) == 1 ] && zenity --title="Asistente de Actualización a Canaima 3.0" --text="¡Existe un getor de paquetes trabajando! No podemos continuar." --error --width=600 && exit 1

. ${PASO_BASH}
case ${PASO} in

1)
zenity --title="Asistente de Actualización a Canaima 3.0" --text="Este asistente se encargará de hacer los cambios necesarios\npara actualizar el sistema a la versión 3.0 de Canaima.\n\nSe realizará la actualizacion de gran cantidad de paquetes\nLas aplicaciones que ud haya instalado en 2.X que requieran\nconfiguración durante la instalacion ameritaran de su intervención para ser configuradas, \nel resto de la actualización se realizará de forma transparente.\n\n\nSe recomienda conectar el equipo a una fuente de alimentación continua, al finalizar la actualizacion el sistema se reiniciará automaticamente, no apagague el equipo hasta haber recibido el mensaje de \"Actualizacion Completada\".\nSe descargarán aprox: 1200MB.\n\n¿Desea continuar con la actualización?" --question --width=600
echo 'PASO=2' > ${PASO_BASH}
asistente-actualizacion
;;

2)

echo "PASO=3" > $PASO_BASH
# ------- PREPARANDO CANAIMA 2.1 ------------------------------------------------------------------#
#==================================================================================================#

debconf-set-selections $BASE"selections.conf"

# Aseguramos que tenemos los repositorios correctos
cat <<EOF >/etc/apt/sources.list
#
# Repositorios de Canaima GNU/Linux
#

# Repositorio Antiguo
deb http://mirror/canaima3/repositorio/ aponwao usuarios

# Repositorio Estable
#deb http://mirror/canaima3/repositorio/ roraima usuarios

# Repositorio de Desarrollo
#deb http://mirror/canaima3/repositorio/ auyantepui usuarios

# Repositorio de la Base (Debian)
deb http://mirror/debian/ lenny main contrib non-free


EOF

;;
3)
# Actualizamos la lista de paquetes
dhclient
( aptitude update | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando lista de paquetes ..." --progress --pulsate --auto-close --width=600
echo "PASO=4" > $PASO_BASH

;;
4)
# Removemos paquetes huérfanos
( apt-get autoclean | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo paquetes huérfanos ..." --progress --pulsate --auto-close --width=600
echo "PASO=5" > $PASO_BASH

;;
5)
# Actualizamos Canaima 2.1
( DEBIAN_FRONTEND=noninteractive aptitude --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" full-upgrade | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando Canaima 2.1 ..." --progress --pulsate --auto-close --width=600
echo "PASO=6" > $PASO_BASH

;;
6)
# Instalamos otro proveedor de gnome-www-browser
( DEBIAN_FRONTEND=noninteractive aptitude install --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" galeon | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Preparando migración de Firefox a Cunaguaro ..." --progress --pulsate --auto-close --width=600
echo "PASO=7" > $PASO_BASH

;;
7)
# Removemos la configuración vieja del GRUB
( rm /etc/default/grub &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Preparando migración de Firefox a Cunaguaro ..." --progress --pulsate --auto-close --width=600
echo "PASO=8" > $PASO_BASH

;;
8)
# Limpiando Canaima 2.1 de aplicaciones no utilizadas en 3.0
( DEBIAN_FRONTEND=noninteractive apt-get purge --force-yes -y openoffice* firefox* thunderbird* canaima-accesibilidad canaima-instalador-vivo canaima-particionador | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Limpiando Canaima 2.1 de aplicaciones no utilizadas en 3.0 ..." --progress --pulsate --auto-close --width=600
echo "PASO=9" > $PASO_BASH

;;
9) 
# Limpiando paquetes huérfanos
( DEBIAN_FRONTEND=noninteractive apt-get autoremove --force-yes -y | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo paquetes huérfanos ..." --progress --pulsate --auto-close --width=600
echo "PASO=10" > $PASO_BASH


;;
10) 
# ------- ACTUALIZANDO COMPONENTES DE INSTALACIÓN DE LA BASE (DEBIAN SQUEEZE) ---------------------#
#==================================================================================================#

# Estableciendo repositorios sólo para el sistema base
cat <<EOF >/etc/apt/sources.list
deb http://mirror/debian/ squeeze main contrib non-free

EOF

# Estableciendo prioridades superiores para paquetes provenientes de Debian
cat <<EOF >/etc/apt/preferences
Package: *
Pin: release o=Debian
Pin-Priority: 800

EOF

echo "PASO=11" > $PASO_BASH

;;
11) 
# Actualizamos la lista de paquetes
dhclient
( aptitude update | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando lista de paquetes ..." --progress --pulsate --auto-close --width=600
echo "PASO=12" > $PASO_BASH

;;
12) 
# Removemos paquetes huérfanos
( apt-get autoclean | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo paquetes huérfanos ..." --progress --pulsate --auto-close --width=600
echo "PASO=13" > $PASO_BASH

;;
13) 
# Actualizando componentes fundamentales de instalación
( DEBIAN_FRONTEND=noninteractive aptitude install --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" aptitude apt dpkg debian-keyring locales --without-recommends | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando componentes fundamentales de instalación ..." --progress --pulsate --auto-close --width=600
echo "PASO=14" > $PASO_BASH

;;
14) 
# Arreglando paquetes en mal estado
( DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes -f install | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Arreglando paquetes en mal estado ..." --progress --pulsate --auto-close --width=600
echo "PASO=15" > $PASO_BASH

;;
15) 
# Instalando nuevo Kernel y librerías Perl
( DEBIAN_FRONTEND=noninteractive aptitude install --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" linux-image-2.6.32-5-686 perl libperl5.10 | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Instalando nuevo Kernel y librerías Perl ..." --progress --pulsate --auto-close --width=600
echo "PASO=16" > $PASO_BASH


;;
16) 
dhclient
# Estableciendo repositorios sólo para el sistema base

debconf-set-selections $BASE"selections.conf"
cat <<EOF >/etc/apt/sources.list
deb http://mirror/debian/ squeeze main contrib non-free

EOF

# Estableciendo prioridades superiores para paquetes provenientes de Debian
cat <<EOF >/etc/apt/preferences
Package: *
Pin: release o=Debian
Pin-Priority: 800

EOF

echo "PASO=17" > $PASO_BASH
;;
17) 
# Actualizamos la lista de paquetes
dhclient
( aptitude update | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando lista de paquetes ..." --progress --pulsate --auto-close --width=600


echo "PASO=18" > $PASO_BASH
;;
18) 
# Removemos paquetes huérfanos
( apt-get autoclean | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo paquetes huérfanos ..." --progress --pulsate --auto-close --width=600

echo "PASO=19" > $PASO_BASH

;;
19) 
# Arreglando paquetes en mal estado
( DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes -f install | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Arreglando paquetes en mal estado ..." --progress --pulsate --auto-close --width=600


echo "PASO=20" > $PASO_BASH
;;
20) 
# Actualizando gestor de dispositivos UDEV
( DEBIAN_FRONTEND=noninteractive aptitude install --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" udev | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando gestor de dispositivos UDEV ..." --progress --pulsate --auto-close --width=600



echo "PASO=21" > $PASO_BASH
;;
21) 
# Estableciendo repositorios sólo para el sistema base

debconf-set-selections $BASE"selections.conf"
cat <<EOF >/etc/apt/sources.list
deb http://mirror/debian/ squeeze main contrib non-free

EOF

echo "PASO=22" > $PASO_BASH
;;
22) 
# Estableciendo prioridades superiores para paquetes provenientes de Debian
cat <<EOF >/etc/apt/preferences
Package: *
Pin: release o=Debian
Pin-Priority: 800

EOF

echo "PASO=23" > $PASO_BASH
;;
23) 
dhclient

# Actualizamos la lista de paquetes

( aptitude update | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando lista de paquetes ..." --progress --pulsate --auto-close --width=600

echo "PASO=24" > $PASO_BASH
;;
24) 
# Removemos paquetes huérfanos
( apt-get autoclean | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo paquetes huérfanos ..." --progress --pulsate --auto-close --width=600

echo "PASO=25" > $PASO_BASH
;;
25) 
# Arreglando paquetes en mal estado
( DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes -f install | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Arreglando paquetes en mal estado ..." --progress --pulsate --auto-close --width=600

echo "PASO=26" > $PASO_BASH
;;
26) 
# Actualizando gconf2
( DEBIAN_FRONTEND=noninteractive aptitude --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" install gconf2=2.28.1-6 libgconf2-4=2.28.1-6 gconf2-common=2.28.1-6 | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando gconf2 ..." --progress --pulsate --auto-close --width=600

echo "PASO=27" > $PASO_BASH
;;
27) 
# Actualización de componentes adicionales instalados por el usuario (no incluidos en canaima 2.1)

#dpkg-query -W -f='${Package}\t${Status}\n' | grep "install ok installed" | awk '{ print $1 }' > $BASE/este

#diff $BASE/21 $BASE/este | grep ">" | awk '{ print $2 }' > $BASE/actualizar
for cadauno in $(cat $BASE/actualizar)
do
        todos=$todos" "$cadauno
done
xterm -e "aptitude --assume-yes --allow-untrusted install $todos"

echo "PASO=28" > $PASO_BASH
;;
28) 
# Actualización parcial de la base
( DEBIAN_FRONTEND=noninteractive apt-get --force-yes -y upgrade | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualización parcial de la base ..." --progress --pulsate --auto-close --width=600

echo "PASO=29" > $PASO_BASH
;;
29) 
# Actualización total de la base
( DEBIAN_FRONTEND=noninteractive apt-get --force-yes -y dist-upgrade | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualización total de la base ..." --progress --pulsate --auto-close --width=600

echo "PASO=30" > $PASO_BASH
;;
30) 
# Actualización completa de la base
( DEBIAN_FRONTEND=noninteractive aptitude --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" full-upgrade | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualización completa de la base ..." --progress --pulsate --auto-close --width=600

echo "PASO=31" > $PASO_BASH
;;
31) 
# Estableciendo repositorios sólo para el sistema base

debconf-set-selections $BASE"selections.conf"
cat <<EOF >/etc/apt/sources.list
deb http://mirror/canaima3/repositorio/ roraima usuarios
deb http://mirror/debian/ squeeze main contrib non-free

EOF

echo "PASO=32" > $PASO_BASH
;;
32) 
# Estableciendo prioridades superiores para paquetes provenientes de Debian
cat <<EOF >/etc/apt/preferences
Package: *
Pin: release o=Canaima
Pin-Priority: 900

Package: *
Pin: release o=Debian
Pin-Priority: 800

EOF

echo "PASO=33" > $PASO_BASH
;;
33) 
# Actualizamos la lista de paquetes
dhclient
( aptitude update | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando lista de paquetes ..." --progress --pulsate --auto-close --width=600

echo "PASO=34" > $PASO_BASH
;;
34) 
# Removemos paquetes huérfanos
( apt-get autoclean | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo paquetes huérfanos ..." --progress --pulsate --auto-close --width=600

echo "PASO=36" > $PASO_BASH
;;
36) 
# Arreglando paquetes en mal estado
( DEBIAN_FRONTEND=noninteractive apt-get -y --force-yes -f install | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Arreglando paquetes en mal estado ..." --progress --pulsate --auto-close --width=600

echo "PASO=37" > $PASO_BASH
;;
37) 
# Instalando llaves del repositorio Canaima
( DEBIAN_FRONTEND=noninteractive aptitude install --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" canaima-llaves | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Instalando llaves del repositorio Canaima ..." --progress --pulsate --auto-close --width=600

echo "PASO=38" > $PASO_BASH
;;
38) 
# Removiendo paquetes innecesarios
( DEBIAN_FRONTEND=noninteractive aptitude purge --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" epiphany-browser epiphany-browser-data libgraphviz4 libslab0 gtkhtml3.14 busybox-syslogd dsyslog inetutils-syslogd rsyslog socklog-run sysklogd syslog-ng libfam0c102 | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo paquetes innecesarios ..." --progress --pulsate --auto-close --width=600

echo "PASO=39" > $PASO_BASH
;;
39) 
# Removemos configuraciones obsoletas
rm -rf /etc/skel/.purple/ 
rm /etc/canaima_version 
rm /usr/share/applications/openoffice.org-*

echo "PASO=40" > $PASO_BASH
;;
40) 
dhclient
# Instalando escritorio de Canaima 3.0
( DEBIAN_FRONTEND=noninteractive aptitude install --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" canaima-escritorio-gnome | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Instalando escritorio de Canaima 3.0 ..." --progress --pulsate --auto-close --width=600

echo "PASO=41" > $PASO_BASH
;;
41) 
dhclient
# Removiendo Navegador web de transición
( DEBIAN_FRONTEND=noninteractive aptitude purge --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" galeon | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo Navegador web de transición ..." --progress --pulsate --auto-close --width=600

echo "PASO=42" > $PASO_BASH
;;
42) 
dhclient
# Actualización final a Canaima 3.0
( DEBIAN_FRONTEND=noninteractive aptitude --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" full-upgrade | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualización final a Canaima 3.0 ..." --progress --pulsate --auto-close --width=600

echo "PASO=43" > $PASO_BASH
;;
43) 
dhclient
# Removiendo paquetes innecesarios
( DEBIAN_FRONTEND=noninteractive aptitude purge --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" gstreamer0.10-gnomevfs splashy | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Removiendo paquetes innecesarios ..." --progress --pulsate --auto-close --width=600

echo "PASO=44" > $PASO_BASH
;;
44) 
dhclient
# Actualizando a GDM3
( DEBIAN_FRONTEND=noninteractive aptitude install --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" gdm3 | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando a GDM3 ..." --progress --pulsate --auto-close --width=600

echo "PASO=46" > $PASO_BASH
;;
46) 
dhclient
# Actualizando a BURG
( DEBIAN_FRONTEND=noninteractive aptitude install --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" burg | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando a BURG ..." --progress --pulsate --auto-close --width=600

echo "PASO=47" > $PASO_BASH
;;
47) 
dhclient
# Reinstalando Base de Canaima
( DEBIAN_FRONTEND=noninteractive aptitude reinstall --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" canaima-base | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Reinstalando Base de Canaima ..." --progress --pulsate --auto-close --width=600

echo "PASO=48" > $PASO_BASH
;;
48) 
# Reinstalando Estilo Visual
( DEBIAN_FRONTEND=noninteractive aptitude reinstall --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" canaima-estilo-visual | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Reinstalando Estilo Visual ..." --progress --pulsate --auto-close --width=600

echo "PASO=49" > $PASO_BASH
;;
49) 
# Reinstalando Escritorio
( DEBIAN_FRONTEND=noninteractive aptitude reinstall --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" canaima-escritorio-gnome | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Reinstalando Escritorio ..." --progress --pulsate --auto-close --width=600

##ESTO SE PASO A UN SCRIPT APARTE
#Eliminando kernels anteriores
#for KERNEL in $( dpkg-query -W -f='${Package} ${Version}\t${Status}\n' linux-image* linux-headers* linux-source* linux-kbuild* | grep "install ok installed" | awk '{ print $1"_____"$2 }'); do
#KERNEL_PAQUETE=$( echo ${KERNEL} | sed 's/_____.*//g' )
#KERNEL_VERSION=${KERNEL#${KERNEL_PAQUETE}"_____"}
#[ $( echo ${KERNEL_VERSION} | awk -F . '{print $3}' | sed 's/-.*//g' | sed 's/+.*//g' ) -lt 32 ] && PARA_DESINSTALAR=${PARA_DESINSTALAR}" "${KERNEL_PAQUETE}
#done
#aptitude purge --assume-yes --allow-untrusted -o DPkg::Options::="--force-confmiss" ${PARA_DESINSTALAR}

echo "PASO=50" > $PASO_BASH
;;
50) 
# Actualizando entradas del BURG
( update-burg | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Actualizando entradas del BURG ..." --progress --pulsate --auto-close --width=600

echo "PASO=51" > $PASO_BASH
;;
51) 
# Estableciendo GDM3 como Manejador de Pantalla por defecto
( echo "/usr/sbin/gdm3" > /etc/X11/default-display-manager &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Estableciendo GDM3 como Manejador de Pantalla por defecto ..." --progress --pulsate --auto-close --width=600

echo "PASO=52" > $PASO_BASH
;;
52) 
# Reconfigurando el Estilo Visual
( dpkg-reconfigure canaima-estilo-visual | tee /var/log/salida &&  sleep 2  ) | zenity --title="Asistente de Actualización a Canaima 3.0" --text="Reconfigurando el Estilo Visual ..." --progress --pulsate --auto-close --width=600

echo "PASO=53" > $PASO_BASH
;;
53) 
update-burg

		# Para cada usuario en /home/ ...
		for usuario in /home/*? ; do

			#Obteniendo sólo el nombre del usuario
			usuario_min=$(basename ${usuario})

			#Y en caso de que el usuario sea un usuario activo (existente en /etc/shadow) ...
			case  $(grep "${usuario_min}:.*:.*:.*:.*:.*:::" /etc/shadow) in

				'')
				#No hace nada si no se encuentra en /etc/shadow
				;;

				*)

					# Elimina configuracion de gconf previo
					rm -rf ${usuario}/.gconf/
				;;
			esac

		done


echo 'PASO=70' > ${PASO_BASH}
$BASEfinasist
reboot
echo "Favor, reinicie el Sistema"
exit 0
;;
esac
done
