#!/bin/bash -e
#
# ==============================================================================
# PAQUETE: asistente-actualizacion
# ARCHIVO: postinst
# DESCRIPCIÓN: Configura el sistema despues la instalación del paquete.
# COPYRIGHT:
#  (C) 2010 Luis Alejandro Martínez Faneyth <martinez.faneyth@gmail.com>
#  (C) 2010 Diego Alberto Aguilera Zambrano <daguilera85@gmail.com>
#  (C) 2010 Carlos Alejandro Guerrero Mora <guerrerocarlos@gmail.com>
#  (C) 2010 Francisco Javier Vásquez Guerrero <franjvasquezg@gmail.com>
# LICENCIA: GPL3
# ==============================================================================
#
# Este programa es software libre. Puede redistribuirlo y/o modificarlo bajo los
# términos de la Licencia Pública General de GNU (versión 3).

PKG="asistente-actualizacion"
BASE="/usr/share/asistente-actualizacion/"
LOCAL="/usr/share/asistente-actualizacion/listas/canaima-local-paquetes.list"


case ${1} in

	configure)

	# Listando todos los paquetes presentes en el sistema (Canaima 2.1)
	dpkg-query -W -f='${Package}\t${Status}\n' | grep "install ok installed" | awk '{ print $1 }' > ${LOCAL}
	
	# Permitiendo lectura/escritura para todos los usuarios
	chmod 777 /usr/share/asistente-actualizacion/log/principal.log
		
        # Para cada usuario en /home/ ...
        for usuario in /home/*? ; do

                # Obteniendo sólo el nombre del usuario
                usuario_min=$(basename ${usuario})

		# Y en caso de que el usuario sea un usuario activo (existente en /etc/shadow) y tenga consola en /etc/passwd ...
		if [ $( grep "${usuario_min}:.*:.*:.*:.*:.*:::" /etc/shadow ) == 1 ] && [ $( grep "${usuario_min}:.*:.*:.*:.*:.*:/bin/.*sh" /etc/passwd  ) == 1 ]; then

			# Asegurando que el directorio .config/asistente-actualizacion/ esté creado
			mkdir -p /home/${usuario_min}/.config/asistente-actualizacion/

			# con permisos apropiados
			chown ${usuario_min}:${usuario_min} /home/${usuario_min}/.config/asistente-actualizacion/
			
			# Copia del archivo de configuración que determina si debe ejecutarse asistente-actualizacion al inicio o no
			cp /etc/skel/.config/asistente-actualizacion/mostrar.conf /home/${usuario_min}/.config/asistente-actualizacion/
			
			# con permisos apropiados
			chown ${usuario_min}:${usuario_min} /home/${usuario_min}/.config/asistente-actualizacion/mostrar.conf

		fi
        done

	;;

        abort-upgrade|abort-remove|abort-deconfigure)
        ;;

        *)

		echo "postinst no reconoce el argumento '"${1}"'" >&2
		exit 1

        ;;

esac

#DEBHELPER#

exit 0
